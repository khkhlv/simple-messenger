stages:
  - build
  - test
#  - sonar-check
#  - quality-check
  - docker
  - notify


variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  SONAR_PROJECT_KEY: "hohlov.aleksandr.a_simple-messenger"
  SONAR_ORGANIZATION: "hohlov-aleksandr-a"
  SONAR_HOST_URL: "https://sonarcloud.io"
  DOCKER_HUB_BACKEND_REPO: "khkhlv/messenger-backend"
  DOCKER_HUB_FRONTEND_REPO: "khkhlv/messenger-frontend"
  DOCKER_IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_HUB_USER: "khkhlv"
  TELEGRAM_BOT_TOKEN: $TELEGRAM_BOT_TOKEN
  TELEGRAM_CHAT_ID: $TELEGRAM_CHAT_ID

cache:
  key: maven
  paths:
    - .m2/repository

build-backend:
  image: maven:3.8.6-openjdk-18
  stage: build
  tags:
    - messenger
  script:
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

build-frontend:
  image: node:20
  stage: build
  tags:
    - messenger
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour

test-backend:
  image: maven:3.8.6-openjdk-18
  stage: test
  tags:
    - messenger
  script:
    - mvn $MAVEN_CLI_OPTS test
    - mvn test jacoco:report
  artifacts:
    paths:
      - target/site/jacoco/jacoco.xml
    reports:
      junit: target/surefire-reports/*.xml
  needs: ["build-backend"]

test-frontend:
  image: node:20
  stage: test
  tags:
    - messenger
  script:
    - cd frontend
    - npm ci --cache .npm --prefer-offline
    - npm test
  artifacts:
    when: always
  needs: ["build-frontend"]

#sonar-check:
#  image: maven:3-openjdk-18
#  stage: sonar-check
#  tags:
#    - messenger
#  script:
#    - mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.tests=src/test/java/ru/khkhlv -Dsonar.organization=$SONAR_ORGANIZATION -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.login=$SONAR_TOKEN -Dsonar.sources=src/main/java -Dsonar.tests=src/test/java -Dsonar.java.binaries=target/classes -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
#  dependencies:
#    - test
#
#check-metrics:
#  image: praqma/network-multitool:latest
#  stage: quality-check
#  tags:
#    - messenger
#  before_script:
#    - apk add --no-cache jq curl bc
#  script:
#    - |
#      echo "Waiting for SonarQube analysis to be available..."
#      sleep 10
#
#      PROJECT_KEY="$SONAR_PROJECT_KEY"
#      MAX_ATTEMPTS=5
#      ATTEMPT=0
#
#      while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
#        STATUS=$(curl -s -u "$SONAR_TOKEN": "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$PROJECT_KEY" | jq -r '.projectStatus.status')
#        echo "$STATUS"
#        if [ "$STATUS" = "OK" ]; then
#          echo "‚úÖ Quality Gate passed"
#          break
#        elif [ "$STATUS" = "ERROR" ]; then
#          echo "‚ùå Quality Gate failed"
#          exit 1
#        fi
#        sleep 10
#        ATTEMPT=$((ATTEMPT+1))
#      done
#
#      if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
#        echo "‚è∞ Timeout waiting for Quality Gate"
#        exit 1
#      fi
#
## –°–±–æ—Ä–∫–∞ –∏ –ø—É—à Docker-–æ–±—Ä–∞–∑–∞
docker:
  stage: docker
  image: docker:24
  tags:
    - messenger
  services:
    - name: docker:24-dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: ""  # –æ—Ç–∫–ª—é—á–∞–µ–º TLS –¥–ª—è dind –≤ CI
  before_script:
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  script:
    - docker build -t "$DOCKER_HUB_BACKEND_REPO:latest" .
    - docker push "$DOCKER_HUB_BACKEND_REPO:latest"
    - docker build -t "$DOCKER_HUB_FRONTEND_REPO:latest" -f frontend/Dockerfile frontend/
    - docker push "$DOCKER_HUB_FRONTEND_REPO:latest"

  after_script:
    - docker logout

# ====== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ======
.notify_template: &notify_template |
  STATUS_ICON="‚ö†Ô∏è"
  STATUS_TEXT="–ù–ï–ò–ó–í–ï–°–¢–ï–ù"
  if [ "$STATUS" = "success" ]; then
    STATUS_ICON="‚úÖ"
    STATUS_TEXT="–£–°–ü–ï–®–ù–û"
  elif [ "$STATUS" = "failed" ]; then
    STATUS_ICON="‚ùå"
    STATUS_TEXT="–ü–†–û–í–ê–õ"
  fi
  
  MESSAGE="\
  ${STATUS_ICON} Pipeline #${CI_PIPELINE_ID} ‚Äî ${STATUS_TEXT}
  
  üì¶ –ü—Ä–æ–µ–∫—Ç: ${CI_PROJECT_NAME}
  üåø –í–µ—Ç–∫–∞: ${CI_COMMIT_REF_NAME}
  üí° Commit: ${CI_COMMIT_SHORT_SHA}
  üë§ –ê–≤—Ç–æ—Ä: ${GITLAB_USER_NAME:-unknown}
  
  üß™ Job: ${CI_JOB_NAME}
  ‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${CI_JOB_DURATION:-N/A} —Å–µ–∫
  
  üîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å: ${CI_PIPELINE_URL}"
  
  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id="${TELEGRAM_CHAT_ID}" \
    -d text="${MESSAGE}" \
    -d parse_mode="HTML" > /dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"

notify_on_success:
  stage: notify
  image: alpine:latest
  tags:
    - messenger
  before_script:
    - apk add --no-cache curl
  script:
    - STATUS="success" eval "$NOTIFY_SCRIPT"
  variables:
    NOTIFY_SCRIPT: *notify_template
  rules:
    - if: $CI_PIPELINE_STATUS == "success"
      when: always
  allow_failure: true
  needs: ["docker"]

notify_on_failure:
  stage: notify
  image: alpine:latest
  tags:
    - messenger
  before_script:
    - apk add --no-cache curl
  script:
    - STATUS="failed" eval "$NOTIFY_SCRIPT"
  variables:
    NOTIFY_SCRIPT: *notify_template
  rules:
    - if: $CI_PIPELINE_STATUS == "failed"
      when: always
  allow_failure: true
  needs: ["build-backend", "build-frontend", "test-backend", "test-frontend", "docker"]