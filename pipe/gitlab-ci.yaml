stages:
  - build
  - test
  - sonar-check
  - quality-check
  - create-mr

variables:
  # Отключаем стандартный clone из GitLab
  GIT_STRATEGY: none

  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  SONAR_PROJECT_KEY: "simple_messenger"
  MAX_ATTEMPTS: "10"

  # GitHub repo (публичный — без токена)
  GITHUB_REPO: "https://github.com/khkhlv/simple-messenger.git"

# Клонируем актуальный код из GitHub перед всеми job'ами
before_script:
  - echo "Cloning from GitHub..."
  - git init
  - git remote add origin $GITHUB_REPO
  - git fetch --depth=1 origin master
  - git checkout FETCH_HEAD
  - echo "Checked out commit: $(git rev-parse HEAD)"

cache:
  key: maven
  paths:
    - .m2/repository

build:
  image: maven:3.8.6-openjdk-18
  stage: build
  tags:
    - messenger
  script:
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

test:
  image: maven:3.8.6-openjdk-18
  stage: test
  tags:
    - messenger
  script:
    - mvn $MAVEN_CLI_OPTS test
    - mvn test jacoco:report
  artifacts:
    paths:
      - target/site/jacoco/jacoco.xml
    reports:
      junit: target/surefire-reports/*.xml

sonar-check:
  image: maven:3-openjdk-18
  stage: sonar-check
  tags:
    - messenger
  script:
    - mvn clean install
    - mvn sonar:sonar \
      -Dsonar.tests=src/test/java/ru/khkhlv \
      -Dsonar.projectKey=$SONAR_PROJECT_KEY \
      -Dsonar.host.url=$SONAR_HOST_URL \
      -Dsonar.login=$SONAR_TOKEN \
      -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
      -Dsonar.qualitygate.wait=true
  dependencies:
    - test

check-metrics:
  image: praqma/network-multitool:latest
  stage: quality-check
  tags:
    - messenger
  before_script:
    - apk add --no-cache jq curl bc
  script:
    - sleep 30
    - |
      ATTEMPT=0
      MAX_ATTEMPTS=${MAX_ATTEMPTS:-10}
      PROJECT_KEY="$SONAR_PROJECT_KEY"

      while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
        STATUS=$(curl -s -u "$SONAR_TOKEN": "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=$PROJECT_KEY" | jq -r '.projectStatus.status')
        if [ "$STATUS" = "OK" ]; then
          echo "Quality Gate passed"
          exit 0
        elif [ "$STATUS" = "ERROR" ]; then
          echo "Quality Gate failed"
          exit 1
        fi
        sleep 30
        ATTEMPT=$((ATTEMPT+1))
      done

      echo "Timeout waiting for Quality Gate"
      exit 1

create-merge-request:
  stage: create-mr
  image: alpine:latest
  tags:
    - messenger
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      # Этот job запускается только при триггере на master
      # Но так как мы используем GIT_STRATEGY: none, ветка — не из GitLab
      # Поэтому мы всегда создаём MR из master → main

      PROJECT_ID_ENCODED=$(echo "$CI_PROJECT_PATH" | jq -sRr '@uri')
      SOURCE_BRANCH="master"
      TARGET_BRANCH="main"
      MR_TITLE="Sync from GitHub master"

      EXISTING_MR=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
        "https://gitlab.com/api/v4/projects/$PROJECT_ID_ENCODED/merge_requests?source_branch=$SOURCE_BRANCH&target_branch=$TARGET_BRANCH&state=opened")

      MR_IID=$(echo "$EXISTING_MR" | jq -r '.[0].iid // empty')

      if [ -n "$MR_IID" ]; then
        echo "MR !${MR_IID} already exists — skipping creation"
      else
        echo "Creating MR from $SOURCE_BRANCH → $TARGET_BRANCH"
        curl --fail -X POST \
          --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
          --form "source_branch=$SOURCE_BRANCH" \
          --form "target_branch=$TARGET_BRANCH" \
          --form "title=$MR_TITLE" \
          --form "remove_source_branch=false" \
          --form "squash=false" \
          "https://gitlab.com/api/v4/projects/$PROJECT_ID_ENCODED/merge_requests"
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "trigger"'  # запускается только при триггере из GitHub